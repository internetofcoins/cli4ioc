exports.login=login;var sjcl=require("./crypto/sjcl.js");function login(userid,passcode){nacl=nacl.instantiate();var nonce=nacl.crypto_box_random_nonce();var user_keys=generate_keys(passcode,userid);var user_pubkey=nacl.to_hex(user_keys.boxPk);do_login(user_keys,nonce);continue_session(user_keys,nonce,userid)}function do_login(user_keys,nonce){var session_seed=nacl.random_bytes(4096);var session_keypair=nacl.crypto_box_keypair_from_seed(session_seed);var session_sign_seed=nacl.crypto_hash_sha256(session_seed);var session_signpair=nacl.crypto_sign_keypair_from_seed(session_sign_seed);var session_nonce=nacl.to_hex(nonce);var session_hexkey=nacl.to_hex(session_keypair.boxPk);var session_hexsign=nacl.to_hex(session_signpair.signPk);var session_seckey=nacl.to_hex(session_keypair.boxSk);var session_secsign=nacl.to_hex(session_signpair.signSk);najax({url:nodepath+"x/"+session_hexsign+"/"+session_step,dataType:"json"}).done(function(data){if(clean(data.nonce1).length==48){session_step++;var nonce2=nacl.crypto_box_random_nonce();var nonce2_hex=nacl.to_hex(nonce2);var nonce2_hex=nonce2_hex.replace(/^[8-9a-f]/,function(match){var range=["8","9","a","b","c","d","e","f"];return range.indexOf(match)});var nonce1_hex=clean(data.nonce1);var nonce1=nacl.from_hex(nonce1_hex);var nonce1_hex=nonce1_hex.replace(/^[8-9a-f]/,function(match){var range=["8","9","a","b","c","d","e","f"];return range.indexOf(match)});var secrets_json={nonce1:nonce1_hex,nonce2:nonce2_hex,client_session_pubkey:session_hexkey};var session_secrets=JSON.stringify(secrets_json);var crypt_bin=nacl.encode_utf8(session_secrets);var crypt_response=nacl.crypto_sign(crypt_bin,session_signpair.signSk);var crypt_hex=nacl.to_hex(crypt_response);najax({url:nodepath+"x/"+session_hexsign+"/"+session_step+"/"+crypt_hex,dataType:"json"}).done(function(data){var server_sign_binkey=nacl.from_hex(clean(data.server_sign_pubkey));var crypt_bin=nacl.from_hex(clean(data.crhex));var crypt_pack=nacl.crypto_sign_open(crypt_bin,server_sign_binkey);var crypt_str=nacl.decode_utf8(crypt_pack);var crypt_vars=JSON.parse(crypt_str);if(crypt_vars.server_sign_pubkey==data.server_sign_pubkey){var key_array={nonce:session_nonce,nonce1:nonce1_hex,nonce2:nonce2_hex,session_secsign:session_secsign,session_seckey:session_seckey,session_pubsign:session_hexsign,session_pubkey:session_hexkey,server_pubsign:crypt_vars.server_sign_pubkey,server_pubkey:crypt_vars.server_session_pubkey};var sess_bin=nacl.encode_utf8(JSON.stringify(key_array));var sess_response=nacl.crypto_box(sess_bin,nonce,user_keys.boxPk,user_keys.boxSk);var sess_hex=nacl.to_hex(sess_response);GL.sessiondata=sess_hex}})}})}next_step=function(){var current_session=session_step;session_step++;return current_session+1};read_session=function(user_keys,nonce){if(GL.sessiondata==null){console.log("Error: Cannot set up encrypted session. Please check your connectivity!");process.exit(404)}var sess_bin=nacl.from_hex(GL.sessiondata);var session_data=nacl.crypto_box_open(sess_bin,nonce,user_keys.boxPk,user_keys.boxSk);var session_string=nacl.decode_utf8(session_data);return JSON.parse(session_string)};function continue_session(user_keys,nonce,userid){var session_watch=GL.sessiondata;if(session_watch==""){setTimeout(function(){continue_session(user_keys,nonce,userid)},1e3)}else{setTimeout(function(){GL.session={user_keys:user_keys,nonce:nonce,userid:userid}},3e3)}}function generate_keys(secret,salt){var secr_ba=sjcl.codec.utf8String.toBits(secret.toUpperCase());var salt_ba=sjcl.codec.utf8String.toBits(salt.toLowerCase());var key_seed1=sjcl.misc.pbkdf2(secr_ba,salt_ba,5e3,4096,false);var rsecret=secret.toUpperCase().split("").reverse().join("");var rsecr_ba=sjcl.codec.utf8String.toBits(rsecret);var usalt_ba=sjcl.codec.utf8String.toBits(salt.toUpperCase());var key_seed2=sjcl.misc.pbkdf2(rsecr_ba,usalt_ba,5e3,4096,false);var key_seed3=sjcl.misc.pbkdf2(key_seed1,key_seed2,5e3,4096,false);var key_seed_str3=sjcl.codec.hex.fromBits(key_seed3);var final_key_seed=nacl.from_hex(key_seed_str3);var user_key=nacl.crypto_box_keypair_from_seed(final_key_seed);return user_key}function clean(dirty){var dirty_str=dirty.toString();var clean_str=dirty_str.replace(/[^A-Za-z0-9]/g,"");return clean_str}
